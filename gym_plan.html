<!-- /gym_plan.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plan de gimnasio ‚Äì Volcanes Ultimate</title>

  <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Estilos -->
  <link rel="stylesheet" href="./css/main.css" />
  <link rel="stylesheet" href="./css/dashboard.css" />
</head>

<body class="loading">
  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
      <div>
        <h1 class="h4 mb-1" id="planTitle">Plan de gimnasio</h1>
        <div class="text-muted small" id="planMeta"></div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary d-none" id="copyLinkBtn">Copiar link</button>
        <a class="btn btn-sm btn-outline-secondary" href="/playbook.html">Volver</a>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div id="planDesc" class="mb-0 text-muted"></div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-end flex-wrap gap-2 mb-2">
      <div>
        <div class="fw-semibold">Rutinas del plan</div>
        <div class="text-muted small">Lista de rutinas incluidas en este plan.</div>
      </div>
    </div>

    <div class="list-group" id="routinesList"></div>
    <div class="text-muted small mt-3 d-none" id="emptyState">Este plan no tiene rutinas configuradas.</div>

    <div class="mt-3 text-danger small d-none" id="errorBox"></div>
  </main>

  <script type="module">
  import { db } from "/js/auth/firebase.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const COL_PLANS = "gym_weeks";
  const COL_ROUTINES = "gym_routines";

  const $ = {
    planTitle: document.getElementById("planTitle"),
    planMeta: document.getElementById("planMeta"),
    planDesc: document.getElementById("planDesc"),
    routinesList: document.getElementById("routinesList"),
    emptyState: document.getElementById("emptyState"),
    errorBox: document.getElementById("errorBox"),
    copyLinkBtn: document.getElementById("copyLinkBtn"),
  };

  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  if (!id) {
    showError("Falta ?id del plan.");
    throw new Error("Missing plan id");
  }

  $.copyLinkBtn?.classList.remove("d-none");
  $.copyLinkBtn?.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(window.location.href);
      const old = $.copyLinkBtn.textContent;
      $.copyLinkBtn.textContent = "Copiado ‚úÖ";
      setTimeout(() => ($.copyLinkBtn.textContent = old), 1200);
    } catch (e) {
      console.error(e);
    }
  });

  boot();

  async function boot() {
    try {
      const snap = await getDoc(doc(db, COL_PLANS, id));
      if (!snap.exists()) {
        showError("Este plan no existe.");
        return;
      }

      const plan = { id: snap.id, ...snap.data() };

      // Header
      const title =
        plan.title ||
        plan.name ||
        (plan.monthKey ? `Plan de gimnasio ‚Äì Mes ${plan.monthKey}` : "Plan de gimnasio");
      $.planTitle.textContent = title;

      const meta = [];
      if (plan.monthKey) meta.push(`Mes: ${plan.monthKey}`);
      if (plan.clubId) meta.push(`Club: ${plan.clubId}`);
      if (plan.isPublic === true) meta.push("üåê P√∫blico");
      $.planMeta.textContent = meta.join(" ¬∑ ");

      $.planDesc.textContent = (plan.description || "").toString().trim() || "‚Äî";

      // Preferimos slots (nuevo modelo)
      const slots = Array.isArray(plan.slots) ? plan.slots.slice() : [];
      if (slots.length) {
        slots.sort((a, b) => Number(a.order ?? 0) - Number(b.order ?? 0));

        const routineIds = uniq(
          slots.map(s => (s?.routineId || "").toString().trim()).filter(Boolean)
        );

        const routinesById = await fetchRoutinesById(routineIds);
        renderSlots(slots, routinesById);
        return;
      }

      // Fallback legacy: routineIds
      const routineIds = Array.isArray(plan.routineIds) ? plan.routineIds.filter(Boolean) : [];
      if (routineIds.length) {
        const routinesById = await fetchRoutinesById(routineIds);
        renderRoutinesFlat(routineIds, routinesById);
        return;
      }

      $.emptyState.classList.remove("d-none");
    } catch (e) {
      console.error(e);
      showError("No pude cargar el plan (permisos o error de red).");
    } finally {
      document.body.classList.remove("loading");
    }
  }

  async function fetchRoutinesById(ids) {
    // Traemos doc por doc (simple y seguro con reglas)
    const snaps = await Promise.all(
      ids.map(rid => getDoc(doc(db, COL_ROUTINES, rid)))
    );

    const map = new Map();
    for (const rs of snaps) {
      if (!rs || !rs.exists()) continue;
      const r = { id: rs.id, ...rs.data() };
      if (r.isActive === false) continue;
      map.set(r.id, r);
    }
    return map;
  }

  function renderSlots(slots, routinesById) {
    $.routinesList.innerHTML = "";
    $.emptyState.classList.add("d-none");

    // Render como tabla
    const wrapper = document.createElement("div");
    wrapper.className = "table-responsive";

    wrapper.innerHTML = `
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:60px;">#</th>
            <th style="width:220px;">Slot</th>
            <th>Rutina</th>
            <th style="width:160px;"></th>
          </tr>
        </thead>
        <tbody id="slotsTbody"></tbody>
      </table>
    `;

    $.routinesList.appendChild(wrapper);

    const tbody = wrapper.querySelector("#slotsTbody");
    tbody.innerHTML = "";

    for (const s of slots) {
      const rid = (s?.routineId || "").toString();
      const r = routinesById.get(rid) || null;

      const routineName = r?.name || (rid ? "Rutina (no accesible)" : "‚Äî");
      const label = (s?.label || "").toString().trim() || "‚Äî";
      const order = Number(s?.order ?? 0) || "";

      const isPublic = r?.isPublic === true;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(order)}</td>
        <td>${escapeHtml(label)}</td>
        <td>
          <div class="fw-semibold">${escapeHtml(routineName)}</div>
          ${r?.description ? `<div class="text-muted small">${escapeHtml(r.description)}</div>` : ``}
          ${!r && rid ? `<div class="text-muted small">ID: ${escapeHtml(rid)}</div>` : ``}
        </td>
        <td class="text-end">
          ${
            isPublic
              ? `<a class="btn btn-sm btn-outline-secondary" href="/gym_routine.html?id=${encodeURIComponent(r.id)}" target="_blank" rel="noopener">Ver rutina</a>`
              : `<span class="text-muted small">${r ? "üîí Privada" : ""}</span>`
          }
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderRoutinesFlat(orderIds, routinesById) {
    $.routinesList.innerHTML = "";

    const routines = orderIds
      .map(id => routinesById.get(id))
      .filter(Boolean);

    if (!routines.length) {
      $.emptyState.classList.remove("d-none");
      return;
    }
    $.emptyState.classList.add("d-none");

    for (const r of routines) {
      const isPublic = r.isPublic === true;
      const row = document.createElement("div");
      row.className = "list-group-item";

      row.innerHTML = `
        <div class="d-flex justify-content-between gap-2 flex-wrap">
          <div>
            <div class="fw-semibold">${escapeHtml(r.name || "‚Äî")}</div>
            <div class="text-muted small">${isPublic ? "üåê P√∫blica" : "üîí Privada"}</div>
            ${r.description ? `<div class="small mt-1">${escapeHtml(r.description)}</div>` : ``}
          </div>
          <div class="d-flex gap-2 flex-wrap">
            ${isPublic ? `<a class="btn btn-sm btn-outline-secondary" href="/gym_routine.html?id=${encodeURIComponent(r.id)}" target="_blank" rel="noopener">Ver rutina</a>` : ``}
          </div>
        </div>
      `;
      $.routinesList.appendChild(row);
    }
  }

  function uniq(arr) {
    return Array.from(new Set(arr));
  }

  function showError(msg) {
    $.errorBox.textContent = msg;
    $.errorBox.classList.remove("d-none");
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
</script>
</body>
</html>